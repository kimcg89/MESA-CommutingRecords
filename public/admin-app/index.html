<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- 2025.12.20 수정: 관리자 전용 타이틀 -->
    <title>MESA 관리자 대시보드</title>

    <!-- 2025.12.20 수정: CSS 파일 분리 및 모듈화 -->
    <link rel="stylesheet" href="./css/base.css" />
    <link rel="stylesheet" href="./css/layout.css" />
    <link rel="stylesheet" href="./css/components.css" />
    <link rel="stylesheet" href="./css/organization.css" />
    <link rel="stylesheet" href="./css/worktime.css" />
    <link rel="stylesheet" href="./css/responsive.css" />

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

    <!-- 네이버 지도 API (worktime 기능용) -->
    <script
      type="text/javascript"
      src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=dfu49htc2u&submodules=geocoder,drawing"
    ></script>

    <!-- Chart.js (근무건수 분석용) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>

    <!-- 2025.12.20 수정: 스크립트 로드 순서 최적화 -->
    <!-- 1. Firebase API 설정 (가장 먼저) -->
    <script src="./js/config/firebase-api-config.dev.js"></script>

    <!-- 2. Firebase 초기화 설정 -->
    <script src="./js/config/firebase-config.js"></script>

    <!-- 3. 관리자 설정 -->
    <script src="./js/config/admin-config.js"></script>
    <script src="./js/config/naver-api-config.js"></script>

    <!-- 4. 기존 Firebase 모듈 (임시 호환성 유지) -->
    <script src="./admin-firebase.js"></script>

    <!-- 5. UI 모듈들 -->
    <script src="./js/ui/modal-manager.js"></script>
    <script src="./js/ui/admin-panels.js"></script>
    <script src="./js/ui/event-handlers.js"></script>

    <!-- 6. 기능 모듈들 (2025.01.21 15:45 수정: 올바른 순서) -->
    <script src="./js/auth/admin-auth.js"></script>
    <script src="./js/auth/auth-utils.js"></script>
    <script src="./js/organization/org-manager.js"></script>
    <script src="./js/modules/worktime-data-manager.js"></script>
    <script src="./js/modules/worktime-modal-manager.js"></script>
    <script src="./js/modules/worktime-filter-manager.js"></script>

    <!-- 🆕 GPS 관련 모듈들 (순서 중요) - 2025.08.19 14:00 추가 -->
    <script src="./js/modules/gps-data-processor.js"></script>
    <script src="./js/modules/gps-marker-manager.js"></script>
    <script src="./js/modules/gps-path-drawer.js"></script>
    <script src="./js/modules/worktime-gps-manager.js"></script>

    <!-- 🆕 근무건수 분석 모듈들 (순서 중요) - 2025.08.19 수정 -->
    <script src="./js/modules/worktime-analytics.js"></script>
    <script src="./js/modules/worktime-chart-manager.js"></script>
    <script src="./js/modules/worktime-detail-manager.js"></script>

    <!-- 7. 메인 애플리케이션 (가장 마지막) -->
    <script src="./js/app.js"></script>
  </head>
  <body>
    <!-- 사이드바 - 2025.08.14 수정: 관리자 전용으로 변경 -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="header-top">
          <!-- 2025.08.14 수정: 관리자패널로 변경 -->
          <h1>관리자패널</h1>
          <div class="user-info-compact">
            <div class="user-name-compact">로그인 중...</div>
            <div class="user-dept-compact">
              로딩중...
              <button
                class="logout-btn-icon"
                onclick="firebaseAuthManager.logout()"
                title="로그아웃"
              >
                🚪
              </button>
            </div>
          </div>
        </div>

        <!-- 2025.08.14 수정: 관리자 전용 메뉴로 교체 -->
        <div class="nav-menu-grid">
          <a
            href="#"
            class="nav-link-grid active"
            style="text-decoration: none"
            onclick="showAdminPanel('org-management')"
          >
            <span class="nav-icon-grid"></span>
            조직관리
          </a>
          <a
            href="#"
            class="nav-link-grid"
            style="text-decoration: none"
            onclick="showAdminPanel('user-management')"
          >
            <span class="nav-icon-grid"></span>
            사용자관리
          </a>
          <a
            href="#"
            class="nav-link-grid"
            style="text-decoration: none"
            onclick="showAdminPanel('attendance-management')"
          >
            <span class="nav-icon-grid"></span>
            출퇴근관리
          </a>
          <a
            href="#"
            class="nav-link-grid"
            style="text-decoration: none"
            onclick="showAdminPanel('system-settings')"
          >
            <span class="nav-icon-grid"></span>
            시스템설정
          </a>
        </div>
      </div>

      <div class="user-controls">
        <div class="search-box">
          <input
            type="text"
            id="task-search"
            placeholder="조직원 검색 (이름, 직급, 업무, 이메일)"
          />
          <span class="search-icon">🔍</span>
        </div>
        <!-- 필터 상태 표시 영역은 JavaScript에서 동적으로 생성됩니다 -->
      </div>

      <div class="user-menu">
        <div class="menu-section">
          <div class="menu-title">
            조직도
            <span class="user-count" id="org-count">로딩중</span>
          </div>
          <ul class="user-list" id="org-list">
            <div class="loading-indicator">조직도 로드 중</div>
          </ul>
        </div>
      </div>
    </div>

    <!-- 메인 컨텐츠 -->
    <div class="main-content">
      <div class="dashboard-header">
        <h1 class="dashboard-title">근로 기록 현황</h1>
      </div>

      <!-- 필터 컨트롤 -->
      <div class="worktime-filter-controls">
        <div class="worktime-filter-row">
          <!-- 기본 필터 섹션 -->
          <div class="filter-section primary">
            <!-- 기간 선택 -->
            <div class="worktime-filter-group wide">
              <label class="worktime-filter-label">기간 선택</label>
              <select
                class="worktime-filter-select"
                id="worktime-period-select"
              >
                <option value="today">오늘</option>
                <option value="week">1주일</option>
<option value="month" selected>1개월</option>
<option value="month_3">3개월</option>
                <option value="custom">사용자 정의</option>
              </select>
            </div>

            <!-- 커스텀 날짜 입력 -->
            <div class="custom-date-inputs" id="custom-date-inputs">
              <div class="date-input-group">
                <label class="date-input-label">시작일</label>
                <input
                  type="date"
                  class="worktime-filter-input"
                  id="worktime-start-date"
                />
              </div>
              <div class="date-input-group">
                <label class="date-input-label">종료일</label>
                <input
                  type="date"
                  class="worktime-filter-input"
                  id="worktime-end-date"
                />
              </div>
            </div>
            <!-- 부서별 -->
            <div class="worktime-filter-group">
              <label class="worktime-filter-label">부서별</label>
              <select
                class="worktime-filter-select"
                id="worktime-department-filter"
              >
                <option value="all">전체 부서</option>
                <option value="전략사업본부">전략사업본부</option>
                <option value="ICT본부">ICT본부</option>
                <option value="TA본부">TA본부</option>
                <option value="서비스본부">서비스본부</option>
                <option value="CX혁신본부">CX혁신본부</option>
              </select>
            </div>
            <!-- 팀별 -->
            <div class="worktime-filter-group">
              <label class="worktime-filter-label">부서별</label>
              <select class="worktime-filter-select" id="worktime-team-filter">
                <option value="all">전체 팀</option>
                <option value="전략영업">전략영업</option>
                <option value="ICT본부">ICT영업</option>
                <option value="TA본부">TA팀</option>
                <option value="기술1팀">기술1팀</option>
                <option value="기술2팀">기술2팀</option>
                <option value="CX데이터랩">CX데이터랩</option>
              </select>
            </div>

            <!-- 직급별 -->
            <div class="worktime-filter-group">
              <label class="worktime-filter-label">직급별</label>
              <select
                class="worktime-filter-select"
                id="worktime-position-filter"
              >
                <option value="all">전체 직급</option>
                <option value="전무">전무</option>
                <option value="상무">상무</option>
                <option value="이사">이사</option>
                <option value="부장">부장</option>
                <option value="차장">차장</option>
                <option value="과장">과장</option>
                <option value="대리">대리</option>
                <option value="선임">선임</option>
              </select>
            </div>
          </div>

          <!-- 세부 필터 섹션 -->
          <div class="filter-section secondary"></div>
        </div>
      </div>

      <!-- 통계 카드 -->
      <div class="worktime-stats-cards">
        <!-- 1. 평균 근무시간 카드 -->
        <!-- <div class="worktime-stats-card primary">
        <div class="card-header">
            <h3 class="card-title">평균 근무시간</h3>
            <div class="card-icon primary">⏰</div>
        </div>
        <div class="card-content">
            <div class="main-value" id="worktime-avg-hours">0시간</div>
            <div class="sub-values">
                <div class="sub-value">
                    <span class="sub-value-label">인당 총 근무시간(평균)</span>
                    <span class="sub-value-number" id="worktime-total-per-person">0시간</span>
                </div>
                <div class="sub-value">
                    <span class="sub-value-label">기준 근무시간</span>
                    <span class="sub-value-number" id="worktime-standard-hours">0시간</span>
                </div>
            </div>
            <div class="change-indicator positive" id="worktime-hours-change">+0%</div>
        </div>
    </div> -->

        <!-- 2. 내외근 현황 카드 -->
        <div class="worktime-stats-card success">
          <div class="card-header">
            <h3 class="card-title">내외근 현황</h3>
            <div class="card-icon success">🏢</div>
          </div>
          <div class="card-content">
            <div class="status-grid">
              <div class="status-item office">
                <div class="status-number" id="office-worker-count">0</div>
                <div class="status-label">내근</div>
              </div>
              <div class="status-item field">
                <div class="status-number" id="field-worker-count">0</div>
                <div class="status-label">외근/재택</div>
              </div>
            </div>
            <!-- 내근 비율 -->
            <div class="sub-value" style="margin-top: 0.75rem">
              <span class="sub-value-label">내근 비율</span>
              <span class="sub-value-number" id="office-ratio">0%</span>
            </div>

            <!-- 🆕 외근/재택 비율 -->
            <div class="sub-value">
              <span class="sub-value-label">외근/재택 비율</span>
              <span class="sub-value-number" id="remote-ratio">0%</span>
            </div>

            <!-- <div
              class="change-indicator positive"
              id="worktime-attendance-change"
            >
              +0%
            </div> -->
            <button
              class="worktime-filter-btn"
              onclick="openAttendanceDetailModal()"
              style="margin-top: 1rem; width: 100%; font-size: 0.8rem"
            >
              📋 상세 보기
            </button>
          </div>
        </div>

        <!-- 3. 휴가자 수 카드 -->
        <div class="worktime-stats-card warning">
          <div class="card-header">
            <h3 class="card-title">휴가자 수</h3>
            <div class="card-icon warning">🏝️</div>
          </div>
          <div class="card-content">
            <div class="period-tabs">
              <div
                class="period-tab active"
                onclick="switchVacationPeriod('today')"
              >
                오늘
              </div>
              <div class="period-tab" onclick="switchVacationPeriod('week')">
                이번주
              </div>
              <div class="period-tab" onclick="switchVacationPeriod('month')">
                이번달
              </div>
            </div>
            <div class="main-value" id="vacation-count">0명</div>
            <div class="sub-values">
              <div class="sub-value">
                <span class="sub-value-label">연차휴가</span>
                <span class="sub-value-number" id="annual-leave-count"
                  >0명</span
                >
              </div>
              <div class="sub-value">
                <span class="sub-value-label">보상휴가</span>
                <span class="sub-value-number" id="half-comp-leave-count"
                  >0명</span
                >
              </div>
            </div>
            <!-- <div
              class="change-indicator negative"
              id="worktime-vacation-change"
            >
              +0명
            </div> -->
          </div>
          <button
            class="worktime-filter-btn"
            style="margin-top: 0.75rem; width: 100%; font-size: 0.8rem"
            onclick="openVacationDetailModal()"
          >
            📋 상세 보기
          </button>
        </div>

        <!-- 4. 초과근무 카드 -->
        <div class="worktime-stats-card danger">
          <div class="card-header">
            <h3 class="card-title">초과근무</h3>
            <div class="card-icon danger">⚡</div>
          </div>
          <div class="card-content">
            <div class="main-value" id="overtime-total-hours">0시간</div>
            <div class="sub-values">
              <div class="sub-value">
                <span class="sub-value-label">이번달 총계</span>
                <span class="sub-value-number" id="overtime-month-total"
                  >0시간</span
                >
              </div>
              <div class="sub-value">
                <span class="sub-value-label">이번분기 총계</span>
                <span class="sub-value-number" id="overtime-quarter-total"
                  >0시간</span
                >
              </div>
            </div>
            <div class="overtime-summary">
              <span class="overtime-label">인당 평균</span>
              <span class="overtime-value" id="overtime-average">0시간</span>
            </div>
            <div
              class="change-indicator negative"
              id="worktime-overtime-change"
            >
              +0시간
            </div>
          </div>
        </div>
        <!-- 📋 내외근 현황 상세 내역 모달 -->
        <div
          id="attendance-detail-modal"
          class="custom-modal"
          style="display: none"
        >
          <div class="custom-modal-content">
            <div class="custom-modal-header">
              <h3>📍 오늘의 내/외근 상세 현황</h3>
              <button onclick="closeAttendanceDetailModal()">✖</button>
            </div>
            <div class="custom-modal-body">
              <<table class="worktime-data-table attendance-modal-table">
                <thead>
                  <tr>
                    <th>이름</th>
                    <th>부서</th>
                    <th>직급</th>
                    <th>위치 유형</th>
                    <th>좌표</th>
                    <th>시간</th>
                  </tr>
                </thead>
                <tbody id="attendance-detail-body">
                  <tr>
                    <td colspan="6" style="text-align: center">로딩 중...</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <!-- 📋 휴가자 상세 보기 모달 -->
        <div
          id="vacation-detail-modal"
          class="custom-modal"
          style="display: none"
        >
          <div class="custom-modal-content">
            <div class="custom-modal-header">
              <h3>📅 휴가자 상세 현황</h3>
              <button onclick="closeVacationDetailModal()">✖</button>
            </div>
            <div class="custom-modal-body">
              <table class="worktime-data-table vacation-modal-table">
                <thead>
                  <tr>
                    <th>이름</th>
                    <th>부서</th>
                    <th>직급</th>
                    <th>휴가 종류</th>
                    <th>시작</th>
                    <th>종료</th>
                    <th>날짜</th>
                  </tr>
                </thead>
                <tbody id="vacation-detail-body">
                  <tr>
                    <td colspan="7" style="text-align: center">
                      불러오는 중...
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- 차트 및 테이블 -->
      <div class="worktime-data-container">
        <div class="worktime-chart-container">
          <h2 class="worktime-section-title">근무건수 분석</h2>
          <canvas id="worktime-chart" width="400" height="300"></canvas>
        </div>
        <div class="worktime-table-container">
          <h2 class="worktime-section-title">일자별 상세 현황</h2>
          <div class="table-wrapper">
            <table class="worktime-data-table worktime-detail-table">
              <thead>
                <tr>
                  <th>날짜</th>
                  <th>구분</th>
                  <th>직원명</th>
                  <th>GPS 건수</th>
                  <th>이동 거리</th>
                </tr>
              </thead>
              <tbody id="worktime-table-body">
                <!-- 데이터는 script.js에서 동적으로 생성됩니다 -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- 📍 실시간 GPS 위치 정보 섹션 -->
      <div class="worktime-gps-section">
        <h2 class="worktime-section-title">실시간 위치 정보</h2>
        <div>
          <div class="gps-date-picker">
            <button id="gps-prev-date" class="gps-nav-btn" title="이전 날짜">
              ◀ 이전
            </button>
            <span id="gps-current-date">2025-06-05</span>
            <button id="gps-next-date" class="gps-nav-btn" title="다음 날짜">
              다음 ▶
            </button>
            <button id="reset-map-view-btn" class="gps-nav-btn">
              기본 위치로
            </button>
          </div>
        </div>
        <div class="worktime-gps-container">
          <!-- 지도 표시 영역 -->
          <div class="worktime-gps-map" id="worktime-naver-map">
            <!-- 지도 API 필요 (예: Naver 또는 Kakao) -->
            지도 로딩 중...
          </div>
        </div>
      </div>
    </div>

    <!-- 2025.12.20 수정: 간단한 관리자 패널 함수만 유지 -->
    <script>
      // 2025.12.20 수정: 관리자 패널 전환 함수 (최소한만 유지)
      function showAdminPanel(panelType) {
        console.log(
          "🔧 관리자 패널 전환:",
          panelType,
          "-",
          new Date().toISOString()
        );

        // 활성 메뉴 상태 변경
        document.querySelectorAll(".nav-link-grid").forEach((link) => {
          link.classList.remove("active");
        });

        // 클릭된 메뉴 활성화
        event.target.closest(".nav-link-grid")?.classList.add("active");

        // 패널 전환 이벤트 발송 (다른 모듈에서 처리 가능)
        document.dispatchEvent(
          new CustomEvent("adminPanelChanged", {
            detail: { panelType, timestamp: new Date().toISOString() },
          })
        );

        console.log(`📋 ${panelType} 패널로 전환됨`);
      }

      // 전역 접근 가능하도록 설정
      window.showAdminPanel = showAdminPanel;
    </script>
  </body>
</html>
