// attendance-ui.js
// UI ÏóÖÎç∞Ïù¥Ìä∏ Î∞è GPS Í∏∞Î°ù Í¥ÄÎ†® Ìï®ÏàòÎì§ (2025ÎÖÑ 8Ïõî 14Ïùº ÏÉùÏÑ±Îê®)

// Firebase Ï§ÄÎπÑ ÏôÑÎ£å ÌõÑ UI Í¥ÄÎ¶¨ Í∏∞Îä• Ï¥àÍ∏∞Ìôî
document.addEventListener("firebaseReady", (event) => {
  initializeAttendanceUI();
});

// UI Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú Ï¥àÍ∏∞Ìôî (2025ÎÖÑ 8Ïõî 14Ïùº ÏÉùÏÑ±Îê®)
function initializeAttendanceUI() {
  // Í∑ºÎ¨¥ Í∏∞Î°ù Î≤ÑÌäº Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
  const workRecordButton = document.getElementById("workRecordBtn");
  if (workRecordButton) {
    workRecordButton.addEventListener("click", handleGpsInput);
  }
}

// Ï∂úÍ∑º Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ (2025ÎÖÑ 8Ïõî 14Ïùº ÏÉùÏÑ±Îê®)
function updateStartButtonStatus(time = null) {
  const startButton = document.getElementById("startBtn");
  if (!startButton) return;

  if (time) {
    startButton.textContent = time;
    startButton.style.backgroundColor = "#0048B2";
    startButton.disabled = true;
  } else {
    startButton.textContent = "Ï∂úÍ∑º";
    startButton.style.backgroundColor = "";
    startButton.disabled = false;
  }
}

// Ìá¥Í∑º Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ (2025ÎÖÑ 8Ïõî 14Ïùº ÏÉùÏÑ±Îê®)
function updateEndButtonStatus(time = null) {
  const endButton = document.getElementById("endBtn");
  if (!endButton) return;

  if (time) {
    endButton.textContent = time;
    endButton.style.backgroundColor = "#EBEDEF";
    endButton.disabled = true;
  } else {
    endButton.textContent = "Ìá¥Í∑º";
    endButton.style.backgroundColor = "";
    endButton.disabled = false;
  }
}

// Firestore Îç∞Ïù¥ÌÑ∞ Î°úÎìú Î∞è Ï∂úÍ∑º Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ (2025ÎÖÑ 8Ïõî 14Ïùº ÏÉùÏÑ±Îê®)
async function updateStartButton() {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const userEmail = user.email;
  const now = new Date();
  const kstOffset = 9 * 60 * 60 * 1000;
  const kstDate = new Date(now.getTime() + kstOffset);
  const recordDate = kstDate.toISOString().split("T")[0];
  const recordRef = db
    .collection("records")
    .doc(userEmail)
    .collection("dates")
    .doc(recordDate);

  try {
    const doc = await recordRef.get();

    if (doc.exists) {
      const data = doc.data();
      if (data.start && data.start.length > 0) {
        const startTime = data.start[0].time;
        updateStartButtonStatus(startTime);
      } else {
        updateStartButtonStatus();
      }
    } else {
      updateStartButtonStatus();
    }
  } catch (error) {
    console.error("Firestore Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë Ïò§Î•ò Î∞úÏÉù:", error);
  }
}

// Firestore Îç∞Ïù¥ÌÑ∞ Î°úÎìú Î∞è Ìá¥Í∑º Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ (2025ÎÖÑ 8Ïõî 14Ïùº ÏÉùÏÑ±Îê®)
async function updateEndButton() {
  const user = firebase.auth().currentUser;
  if (!user) return;

  const userEmail = user.email;
  const now = new Date();
  const kstOffset = 9 * 60 * 60 * 1000;
  const kstDate = new Date(now.getTime() + kstOffset);
  const recordDate = kstDate.toISOString().split("T")[0];
  const recordRef = db
    .collection("records")
    .doc(userEmail)
    .collection("dates")
    .doc(recordDate);

  try {
    const doc = await recordRef.get();

    if (doc.exists) {
      const data = doc.data();
      if (data.end && data.end.length > 0) {
        const endTime = data.end[data.end.length - 1].time;
        updateEndButtonStatus(endTime);
      } else {
        updateEndButtonStatus();
      }
    } else {
      updateEndButtonStatus();
    }
  } catch (error) {
    console.error("Firestore Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ï§ë Ïò§Î•ò Î∞úÏÉù:", error);
  }
}

// GPS Í∏∞Î°ù ÏûÖÎ†• Î∞è Firestore ÏóÖÎç∞Ïù¥Ìä∏ Ìï®Ïàò (2025ÎÖÑ 8Ïõî 14Ïùº ÏàòÏ†ïÎê®)
async function handleGpsInput() {
  const button = document.getElementById("workRecordBtn");
  button.disabled = true;

  const user = firebase.auth().currentUser;
  if (!user) {
    if (typeof showNoticeModal === "function") {
      showNoticeModal("Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.");
    }
    button.disabled = false;
    return;
  }

  const userId = user.email;
  const now = new Date();
  const kstOffset = 9 * 60 * 60 * 1000;
  const kstDate = new Date(now.getTime() + kstOffset);
  const currentDate = kstDate.toISOString().split("T")[0];

  // ÌòÑÏû¨ ÏÑ†ÌÉùÎêú ÎÇ†ÏßúÍ∞Ä Ïò§ÎäòÏù¥ ÏïÑÎãå Í≤ΩÏö∞, Ïò§Îäò ÎÇ†ÏßúÎ°ú Î≥ÄÍ≤Ω
  if (window.selectedDate !== currentDate) {
    console.log(`üìÖ ÎÇ†Ïßú Î≥ÄÍ≤Ω: ${window.selectedDate} ‚Üí ${currentDate}`);
    
    // Ïò§Îäò ÎÇ†ÏßúÎ°ú ÌûàÏä§ÌÜ†Î¶¨ ÏóÖÎç∞Ïù¥Ìä∏
    if (typeof updateHistoryList === 'function') {
      await updateHistoryList(currentDate);
    } else if (typeof window.updateHistoryList === 'function') {
      await window.updateHistoryList(currentDate);
    }
    
    // ÏÑ†ÌÉùÎêú ÎÇ†Ïßú ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
    if (typeof updateSelectedDateDisplay === 'function') {
      updateSelectedDateDisplay(currentDate);
    }
    
    // Ï£ºÍ∞Ñ Ï∫òÎ¶∞ÎçîÏóêÏÑú Ïò§Îäò ÎÇ†Ïßú Í∞ïÏ°∞
    const weeklyTable = document.querySelector('.weeklyTable');
    if (weeklyTable) {
      const allDays = weeklyTable.querySelectorAll('.day');
      allDays.forEach(day => day.classList.remove('selected'));
      
      // Ïò§Îäò ÎÇ†Ïßú Ï∞æÏïÑÏÑú ÏÑ†ÌÉù ÌëúÏãú
      const today = new Date();
      allDays.forEach(day => {
        const dateSpan = day.querySelector('.date');
        if (dateSpan && parseInt(dateSpan.textContent) === today.getDate()) {
          day.classList.add('selected');
        }
      });
    }
    
    // Ï†ÑÏó≠ selectedDate ÏóÖÎç∞Ïù¥Ìä∏
    window.selectedDate = currentDate;
  }

  // Î°úÎî© Î∏îÎü¨ Ìö®Í≥º ÌëúÏãú
  if (typeof showLoadingBlur === "function") {
    showLoadingBlur("ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò§Îäî Ï§ë...");
  }

  try {
    const { latitude, longitude } = await window.LocationUtils.getCurrentLocation(3, 3000);

    // ÏúÑÏπò Ï†ïÎ≥¥Í∞Ä ÏóÜÎäî Í≤ΩÏö∞ Ï≤òÎ¶¨ (2025ÎÖÑ 8Ïõî 14Ïùº Ï∂îÍ∞ÄÎê®)
    if (latitude === "ÏúÑÏπò Ï†ïÎ≥¥ ÏÇ¨Ïö© Î∂àÍ∞Ä") {
      // ÏúÑÏπò Ï†ïÎ≥¥ ÏóêÎü¨ Î™®Îã¨ ÌëúÏãú
      if (typeof window.AttendanceCore?.showLocationErrorModal === "function") {
        window.AttendanceCore.showLocationErrorModal(() => {
          // Ïû¨ÏãúÎèÑ Ìï®Ïàò: Í∑ºÎ¨¥Ïù¥Î†•ÎÇ®Í∏∞Í∏∞ Î≤ÑÌäº Ï≤òÎ¶¨ Îã§Ïãú Ïã§Ìñâ
          handleGpsInput();
        });
      } else {
        // fallback: ÏùºÎ∞ò ÏóêÎü¨ Ï≤òÎ¶¨
        if (typeof hideLoadingBlur === "function") {
          hideLoadingBlur();
        }
        setTimeout(() => {
          if (typeof showNoticeModal === "function") {
            showNoticeModal("ÏúÑÏπò Ï†ïÎ≥¥Î•º Í∞ÄÏ†∏Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.\n\nÏúÑÏπò ÏÑúÎπÑÏä§Î•º ÌôúÏÑ±ÌôîÌïú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
          }
        }, 100);
      }
      button.disabled = false;
      return;
    }

    // Ï£ºÏÜå Î≥ÄÌôò Ï§ë Î©îÏãúÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
    if (typeof updateLoadingMessage === "function") {
      updateLoadingMessage("Ï£ºÏÜå Ï†ïÎ≥¥Î•º Î≥ÄÌôòÌïòÎäî Ï§ë...");
    }

    const gpsData = `ÏúÑÎèÑ: ${latitude.toFixed(6)}, Í≤ΩÎèÑ: ${longitude.toFixed(6)}`;
    const timestamp = now.toLocaleTimeString();

    // GPS Ï¢åÌëúÎ•º Ï£ºÏÜåÎ°ú Î≥ÄÌôò
    const address = await window.LocationUtils.getAddressFromCoordinates(latitude, longitude);

    // ÏúÑÏπò Í∏∞Î∞ò Í∑ºÎ¨¥ Íµ¨Î∂Ñ ÏûêÎèô ÏÑ§Ï†ï
    const autoWorkType = window.LocationUtils.determineWorkType(latitude, longitude);

    const gpsRecord = {
      time: timestamp,
      gps: gpsData,
      address: address,
      // ÎÇ¥Í∑ºÏù∏ Í≤ΩÏö∞ memo Ï∂îÍ∞Ä (2025ÎÖÑ 8Ïõî 14Ïùº ÏàòÏ†ïÎê®)
      ...(autoWorkType === "ÎÇ¥Í∑º" && {
        memo: {
          project: "",
          work: "ÎÇ¥Í∑º",
          details: "",
        },
      }),
    };

    // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû• Ï§ë Î©îÏãúÏßÄ ÏóÖÎç∞Ïù¥Ìä∏
    if (typeof updateLoadingMessage === "function") {
      updateLoadingMessage("Í∑ºÎ¨¥ Í∏∞Î°ùÏùÑ Ï†ÄÏû•ÌïòÎäî Ï§ë...");
    }

    const docRef = firebase
      .firestore()
      .collection("records")
      .doc(userId)
      .collection("dates")
      .doc(currentDate);

    const doc = await docRef.get();

    if (doc.exists) {
      await docRef.update({
        gps: firebase.firestore.FieldValue.arrayUnion(gpsRecord),
      });
    } else {
      await docRef.set({
        gps: [gpsRecord],
      });
    }

    // historyList Ïª®ÌÖåÏù¥ÎÑà Í∞ÄÏ†∏Ïò§Í∏∞ (ÌòÑÏû¨ ÌëúÏãúÎêú ÌûàÏä§ÌÜ†Î¶¨ Î¶¨Ïä§Ìä∏)
    const historyContainer = document.getElementById("historyList");
    
    // appendHistoryItem Ìò∏Ï∂ú - Ïò§Îäò ÎÇ†ÏßúÏùò ÌûàÏä§ÌÜ†Î¶¨Ïóê Ï∂îÍ∞Ä
    if (historyContainer && typeof appendHistoryItem === "function") {
      const workType = autoWorkType === "ÎÇ¥Í∑º" ? "ÎÇ¥Í∑º" : null;
      appendHistoryItem(
        historyContainer,  // Ïò§Îäò ÎÇ†ÏßúÎ°ú ÏóÖÎç∞Ïù¥Ìä∏Îêú Ïª®ÌÖåÏù¥ÎÑà ÏÇ¨Ïö©
        timestamp, 
        gpsData, 
        address,
        workType
      );
    }

    // Î°úÎî© Î∏îÎü¨ Ïà®Í∏∞Í∏∞
    if (typeof hideLoadingBlur === "function") {
      hideLoadingBlur();
    }

    // ÏÑ±Í≥µ Î©îÏãúÏßÄ ÌëúÏãú (ÏßßÏùÄ ÎîúÎ†àÏù¥ ÌõÑ)
    setTimeout(() => {
      if (typeof showNoticeModal === "function") {
        showNoticeModal("Í∑ºÎ¨¥ Í∏∞Î°ùÏù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§.");
        setTimeout(() => {
          if (typeof closeNoticeModal === "function") {
            closeNoticeModal();
          } else if (typeof closeModal === "function") {
            closeModal();
          }
        }, 500);
      }
    }, 100);

    // 300ÎØ∏ÌÑ∞ Ïù¥ÎÇ¥Ïù∏ Í≤ΩÏö∞ ÎÇ¥Í∑º ÏÉÅÏÑ∏ÎÇ¥Ïö© ÏûÖÎ†• Î™®Îã¨ ÌëúÏãú
    if (autoWorkType === "ÎÇ¥Í∑º") {
      setTimeout(() => {
        if (typeof showOfficeWorkDetailModal === "function") {
          showOfficeWorkDetailModal(timestamp, "gps", currentDate);
        }
      }, 800);
    }
    // 300ÎØ∏ÌÑ∞ Î∞ñÏù∏ Í≤ΩÏö∞ Í∑ºÎ¨¥Íµ¨Î∂Ñ ÏÑ†ÌÉù Î™®Îã¨ ÌëúÏãú
    else if (autoWorkType === null) {
      setTimeout(() => {
        if (typeof showWorkTypeSelectionModal === "function") {
          showWorkTypeSelectionModal(timestamp, "gps", currentDate);
        }
      }, 800);
    }

    // Ï£ºÍ∞Ñ Ï∫òÎ¶∞Îçî ÏóÖÎç∞Ïù¥Ìä∏
    if (typeof updateWeekDates === "function") {
      updateWeekDates();
    }
    if (typeof loadWeeklyData === "function") {
      loadWeeklyData();
    }

  } catch (error) {
    console.error("Ïò§Î•ò Î∞úÏÉù:", error);

    // Î°úÎî© Î∏îÎü¨ Ïà®Í∏∞Í∏∞
    if (typeof hideLoadingBlur === "function") {
      hideLoadingBlur();
    }

    setTimeout(() => {
      if (typeof showNoticeModal === "function") {
        showNoticeModal(error.message);
      }
    }, 100);
  } finally {
    button.disabled = false;
  }
}

// Ï†ÑÏó≠ Î™®ÎìàÎ°ú ÎÇ¥Î≥¥ÎÇ¥Í∏∞ (2025ÎÖÑ 8Ïõî 14Ïùº ÏÉùÏÑ±Îê®)
window.AttendanceUI = {
  updateStartButton,
  updateEndButton,
  updateStartButtonStatus,
  updateEndButtonStatus,
  handleGpsInput,
  initializeAttendanceUI,
};